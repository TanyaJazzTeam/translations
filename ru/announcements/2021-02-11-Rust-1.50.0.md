---
layout: post
title: 'Rust 1.50.0: улучшение индексации массивов, безопасность полей объединений и усовершенствование файловых дескрипторов
author: The Rust Release Team
release: 'true'
---

Команда Rust рада сообщить о выпуске новой версии — 1.50.0. Rust — это язык программирования, позволяющий каждому создавать надёжное и эффективное программное обеспечение.

Если вы установили предыдущую версию Rust средствами `rustup`, то для обновления до версии 1.50.0 вам достаточно выполнить следующую команду:

```console
rustup update stable
```

Если у вас ещё не установлен `rustup`, вы можете [установить его] с соответствующей страницы нашего сайта, а также посмотреть [подробные примечания к выпуску] на GitHub.

## Что вошло в стабильную версию 1.50.0

В этом выпуске мы улучшили индексацию массивов, расширили безопасность полей объединений, усовершенствовали файловые дескрипторы и добавили их в стандартную библиотеку. Смотрите [подробные примечания к выпуску](https://github.com/rust-lang/rust/blob/master/RELEASES.md#version-1500-2021-02-11), чтобы узнать о других изменениях, не представленных в данном анонсе.

### Константные обобщения при индексации массива

Продолжая движение к стабилизации константных обобщений, этот выпуск добавляет реализации `ops::Index` и `IndexMut` для массивов `[T; N]` *любой* длины `const N`. Оператор индексации `[]` уже работал с массивами с помощью встроенной магии компилятора, но на уровне типа массивы до сих пор фактически не реализовывали библиотечные трейты.

```rust
fn second<C>(container: &C) -> &C::Output
where
    C: std::ops::Index<usize> + ?Sized,
{
    &container[1]
}

fn main() {
    let array: [i32; 3] = [1, 2, 3];
    assert_eq!(second(&array[..]), &2); // срезы работали ранее
    assert_eq!(second(&array), &2); // теперь это работает напрямую
}
```

### Безопасные присвоения полям объединения `ManuallyDrop<T>`

В Rust 1.49 появилась возможность добавлять поля `ManuallyDrop<T>` в `union` как допустимый тип в реализации типажа `Drop` для объединений. Однако объединения не знают, какой вариант является действительным (они не уничтожают любое старое значение), так как в Rust для безопасности позволено использовать типы, которые реализуют типаж `Copy`, потому что у них никогда не вызывается `Drop`. Конечно, это верно и для `ManuallyDrop`, поэтому теперь Rust 1.50 позволяет безопасно назначать полям и его.

### Ниша для `File` на Unix-плафтормах

Некоторые типы в Rust имеют определённые ограничения на то, что считать допустимым значением, которое может не охватывать весь диапазон значений. Мы называем любое оставшееся недопустимое значение [нишей], и это место может быть использовано для оптимизации схемы типа. Например, в Rust 1.28 мы представили `NonZero` типы, в которых `0` — ниша, и это позволило представлять `Option<NonZero>` со значением `0` как `None` без выделения лишней памяти.

На Unix-платформах `None` — это просто системный целочисленный файловый дескриптор. Это значит, что у нас есть возможная ниша — по той причине, что он никогда не может быть `-1`! Системные вызовы, которые возвращают файловый дескриптор, используют `-1` для обозначения того, что произошла ошибка (проверяем `errno`), так что `-1` никогда не будет действительным файловым дескриптором. Начиная с Rust 1.50 эта ниша добавлена в определение типа и тоже может быть использована для оптимизации схемы. И, следовательно, `Option<File>` теперь имеет такой же размер, как и `File`.

### Изменения в стандартной библиотеке

В Rust 1.50.0 были стабилизированы следующие 9 функций:

- [`bool::then`]
- [`btree_map::Entry::or_insert_with_key`]
- [`f32::clamp`]
- [`f64::clamp`]
- [`hash_map::Entry::or_insert_with_key`]
- [`Ord::clamp`]
- [`RefCell::take`]
- [`slice::fill`]
- [`UnsafeCell::get_mut`]

И довольно много существующих функций стало `const`:

- [`IpAddr::is_ipv4`]
- [`IpAddr::is_ipv6`]
- [`Layout::size`]
- [`Layout::align`]
- [`Layout::from_size_align`]
- `pow` для всех целочисленных типов
- `checked_pow` для всех целочисленных типов
- `saturating_pow` для всех целочисленных типов
- `wrapping_pow` для всех целочисленных типов
- `next_power_of_two` для всех беззнаковых целочисленных типов
- `checked_power_of_two` для всех беззнаковых целочисленных типов

Смотрите [подробные примечания к выпуску](https://github.com/rust-lang/rust/blob/master/RELEASES.md#version-1500-2021-02-11) для более детальной информации.

### Другие изменения

[Синтаксис](https://github.com/rust-lang/rust/blob/master/RELEASES.md#version-1500-2021-02-11), [пакетный менеджер Cargo] и [анализатор Clippy] также претерпели некоторые изменения.

## Участники 1.50.0

Множество людей собралось вместе, чтобы создать Rust 1.50.0. Мы не смогли бы сделать это без всех вас. [Спасибо!](https://thanks.rust-lang.org/rust/1.50.0/)


[установить его]: https://www.rust-lang.org/install.html
[подробные примечания к выпуску]: https://github.com/rust-lang/rust/blob/master/RELEASES.md#version-1500-2021-02-11
[нишей]: https://rust-lang.github.io/unsafe-code-guidelines/glossary.html#niche
[`IpAddr::is_ipv4`]: https://doc.rust-lang.org/stable/std/net/enum.IpAddr.html#method.is_ipv4
[`IpAddr::is_ipv6`]: https://doc.rust-lang.org/stable/std/net/enum.IpAddr.html#method.is_ipv6
[`Layout::align`]: https://doc.rust-lang.org/stable/std/alloc/struct.Layout.html#method.align
[`Layout::from_size_align`]: https://doc.rust-lang.org/stable/std/alloc/struct.Layout.html#method.from_size_align
[`Layout::size`]: https://doc.rust-lang.org/stable/std/alloc/struct.Layout.html#method.size
[`Ord::clamp`]: https://doc.rust-lang.org/stable/std/cmp/trait.Ord.html#method.clamp
[`RefCell::take`]: https://doc.rust-lang.org/stable/std/cell/struct.RefCell.html#method.take
[`UnsafeCell::get_mut`]: https://doc.rust-lang.org/stable/std/cell/struct.UnsafeCell.html#method.get_mut
[`bool::then`]: https://doc.rust-lang.org/stable/std/primitive.bool.html#method.then
[`btree_map::Entry::or_insert_with_key`]: https://doc.rust-lang.org/stable/std/collections/btree_map/enum.Entry.html#method.or_insert_with_key
[`f32::clamp`]: https://doc.rust-lang.org/stable/std/primitive.f32.html#method.clamp
[`f64::clamp`]: https://doc.rust-lang.org/stable/std/primitive.f64.html#method.clamp
[`hash_map::Entry::or_insert_with_key`]: https://doc.rust-lang.org/stable/std/collections/hash_map/enum.Entry.html#method.or_insert_with_key
[`slice::fill`]: https://doc.rust-lang.org/stable/std/primitive.slice.html#method.fill
[пакетный менеджер Cargo]: https://github.com/rust-lang/cargo/blob/master/CHANGELOG.md#cargo-150-2021-02-11
[анализатор Clippy]: https://github.com/rust-lang/rust-clippy/blob/master/CHANGELOG.md#rust-150
