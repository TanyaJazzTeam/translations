---
layout: post
title: Rust 1.56.0 и Rust 2021
author: The Rust Release Team
release: 'true'
---

The Rust team is happy to announce a new version of Rust, 1.56.0. This stabilizes the 2021 edition as well. Rust is a programming language empowering everyone to build reliable and efficient software.

Если вы установили предыдущую версию Rust средствами `rustup`, то для обновления до версии 1.56.0 вам достаточно выполнить следующую команду:

```console
rustup update stable
```

Если у вас ещё не установлен `rustup`, вы можете [установить его](https://www.rust-lang.org/install.html) с соответствующей страницы нашего веб-сайта, а также посмотреть [подробные примечания к выпуску](https://github.com/rust-lang/rust/blob/master/RELEASES.md#version-1560-2021-10-21) на GitHub.

## Что стабилизировано в 1.56.0

### Rust 2021

We wrote about plans for the Rust 2021 Edition [in May](https://blog.rust-lang.org/2021/05/11/edition-2021.html). Editions are a mechanism for opt-in changes that may otherwise pose backwards compatibility risk. See [the edition guide](https://doc.rust-lang.org/stable/edition-guide/editions/index.html) for details on how this is achieved. This a smaller edition, especially compared to 2018, but there are still some nice quality-of-life changes that require an edition opt-in to avoid breaking some corner cases in existing code. See the new chapters of the edition guide below for more details on each new feature and guidance for migration.

- [Disjoint capture](https://doc.rust-lang.org/edition-guide/rust-2021/disjoint-capture-in-closures.html): closures now capture individual named fields rather than always capturing whole identifiers.
- [`IntoIterator` for arrays](https://doc.rust-lang.org/edition-guide/rust-2021/IntoIterator-for-arrays.html): `array.into_iter()` now iterates over items by value instead of by reference.
- [Or patterns in macro-rules](https://doc.rust-lang.org/edition-guide/rust-2021/or-patterns-macro-rules.html) now match top-level `A|B` in `:pat`.
- [Default Cargo feature resolver](https://doc.rust-lang.org/edition-guide/rust-2021/default-cargo-resolver.html) is now version 2.
- [Добавлено в прелюдию](https://doc.rust-lang.org/edition-guide/rust-2021/prelude.html): `TryInto`, `TryFrom` и `FromIterator`.
- [Panic macros](https://doc.rust-lang.org/edition-guide/rust-2021/panic-macro-consistency.html) now always expect format strings, just like `println!()`.
- [Зарезервирован синтаксис](https://doc.rust-lang.org/edition-guide/rust-2021/reserving-syntax.html) `ident#`, `ident"..."` и `ident'...'`.
- [Следующие предупреждения стали ошибками](https://doc.rust-lang.org/edition-guide/rust-2021/warnings-promoted-to-error.html): `bare_trait_objects` и `ellipsis_inclusive_range_patterns`.

#### Disjoint capture in closures

Closures automatically capture values or references to identifiers that are used in the body, but before 2021, they were always captured as a whole. The new disjoint-capture feature will likely simplify the way you write closures, so let's look at a quick example:

```rust
// Код в 2015 или 2018 редакции
let a = SomeStruct::new();

// Убираем одно из полей структуры
drop(a.x);

// Ok: Используем другое поле структуры
println!("{}", a.y);

// Ошибка: До 2021 редакции потребуется полностью захватить `a`
let c = || println!("{}", a.y);
c();
```

To fix this, you would have had to extract something like `let y = &a.y;` manually before the closure to limit its capture. Starting in Rust 2021, closures will automatically capture only the fields that they use, so the above example will compile fine!

This new behavior is only activated in the new edition, since it can change the order in which fields are dropped. As for all edition changes, an automatic migration is available, which will update your closures for which this matters by inserting `let _ = &a;` inside the closure to force the entire struct to be captured as before.

#### Migrating to 2021

The guide includes migration instructions for all new features, and in general [transitioning an existing project to a new edition](https://doc.rust-lang.org/edition-guide/editions/transitioning-an-existing-project-to-a-new-edition.html). In many cases `cargo fix` can automate the necessary changes. You may even find that no changes in your code are needed at all for 2021!

Каким бы маленьким ни казалось это издание на первый взгляд, оно по-прежнему является результатом кропотливой работы многих участников, которых вы можете найти в отдельном трекере [Rust 2021 celebration and thanks](https://github.com/rust-lang/rust/issues/88623)!

### Cargo `rust-version`

`Cargo.toml` now supports a `[package]` [`rust-version`](https://doc.rust-lang.org/cargo/reference/manifest.html#the-rust-version-field) field to specify the minimum supported Rust version for a crate, and Cargo will exit with an early error if that is not satisfied. This doesn't currently influence the dependency resolver, but the idea is to catch compatibility problems before they turn into cryptic compiler errors.

### New bindings in `binding @ pattern`

Rust pattern matching can be written with a single identifier that binds the entire value, followed by `@` and a more refined structural pattern, but this has not allowed additional bindings in that pattern -- until now!

```rust
struct Matrix {
    data: Vec<f64>,
    row_len: usize,
}

// Раньше нам было необходимо разделить присваивание
// всей структуры и чтение её частей.
let matrix = get_matrix();
let row_len = matrix.row_len;
// или с помощью деструктурирования:
let Matrix { row_len, .. } = matrix;

// С Rust 1.56 можно сделать это в одно действие!
let matrix @ Matrix { row_len, .. } = get_matrix();
```

This actually was allowed in the days before Rust 1.0, but that was removed due to known [unsoundness](https://github.com/rust-lang/rust/pull/16053) at the time. With the evolution of the borrow checker since that time, and with heavy testing, the compiler team determined that this was safe to finally allow in stable Rust!

### Стабилизированные API

Стабилизированы следующие методы и реализации трейтов:

- [`std::os::unix::fs::chroot`](https://doc.rust-lang.org/stable/std/os/unix/fs/fn.chroot.html)
- [`UnsafeCell::raw_get`](https://doc.rust-lang.org/stable/std/cell/struct.UnsafeCell.html#method.raw_get)
- [`BufWriter::into_parts`](https://doc.rust-lang.org/stable/std/io/struct.BufWriter.html#method.into_parts)
- [`core::panic::{UnwindSafe, RefUnwindSafe, AssertUnwindSafe}`](https://github.com/rust-lang/rust/pull/84662)<br> (ранее было только в `std`)
- [`Vec::shrink_to`](https://doc.rust-lang.org/stable/std/vec/struct.Vec.html#method.shrink_to)
- [`String::shrink_to`](https://doc.rust-lang.org/stable/std/string/struct.String.html#method.shrink_to)
- [`OsString::shrink_to`](https://doc.rust-lang.org/stable/std/ffi/struct.OsString.html#method.shrink_to)
- [`PathBuf::shrink_to`](https://doc.rust-lang.org/stable/std/path/struct.PathBuf.html#method.shrink_to)
- [`BinaryHeap::shrink_to`](https://doc.rust-lang.org/stable/std/collections/struct.BinaryHeap.html#method.shrink_to)
- [`VecDeque::shrink_to`](https://doc.rust-lang.org/stable/std/collections/struct.VecDeque.html#method.shrink_to)
- [`HashMap::shrink_to`](https://doc.rust-lang.org/stable/std/collections/hash_map/struct.HashMap.html#method.shrink_to)
- [`HashSet::shrink_to`](https://doc.rust-lang.org/stable/std/collections/hash_set/struct.HashSet.html#method.shrink_to)

Следующие ранее стабилизированные API стали `const`:

- [`std::mem::transmute`](https://doc.rust-lang.org/stable/std/mem/fn.transmute.html)
- [`[T]::first`](https://doc.rust-lang.org/stable/std/primitive.slice.html#method.first)
- [`[T]::split_first`](https://doc.rust-lang.org/stable/std/primitive.slice.html#method.split_first)
- [`[T]::last`](https://doc.rust-lang.org/stable/std/primitive.slice.html#method.last)
- [`[T]::split_last`](https://doc.rust-lang.org/stable/std/primitive.slice.html#method.split_last)

### Прочие изменения

[Синтаксис](https://github.com/rust-lang/rust/blob/master/RELEASES.md#version-1560-2021-10-21), [пакетный менеджер Cargo](https://github.com/rust-lang/cargo/blob/master/CHANGELOG.md#cargo-156-2021-10-21) и [анализатор Clippy](https://github.com/rust-lang/rust-clippy/blob/master/CHANGELOG.md#rust-156) также претерпели некоторые изменения.

### Участники 1.56.0

Множество людей собрались вместе, чтобы создать Rust 1.56.0 и 2021 редакцию. Мы не смогли бы сделать это без всех вас. [Спасибо!](https://thanks.rust-lang.org/rust/1.56.0/)
